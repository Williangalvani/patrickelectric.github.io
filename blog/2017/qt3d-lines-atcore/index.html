<!DOCTYPE html>
<html lang="en">
    <head>
      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
      <link rel="manifest" href="/site.webmanifest">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

      <title>Patrick José Pereira</title>

      <!-- CSS -->
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;print.css" media="print">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;poole.css">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;hyde.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

      

      
      
    </head>

    <body class=" ">
        
            <div class="sidebar">
                <div class="container sidebar-sticky">
                    <div class="sidebar-about">
                        
                          <a href="https:&#x2F;&#x2F;patrickelectric.work"><h2>HOME</h2></a>
                            <div class="avatar"> <img src="https://avatars3.githubusercontent.com/patrickelectric" alt="Patrick José Pereira" itemprop="image"> </div>
                            <h6>Patrick José Pereira</h6>
                            
                            <p class="lead">I am an Electronics Engineer that works with robotic systems, OSS and OSH.</p>
                            <div class="author__urls-wrapper">
                              <!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>
                              <!-- Place this tag where you want the button to render. -->
<!-- Place this tag where you want the button to render. -->
<a class="github-button" href="https://github.com/patrickelectric" data-show-count="true" aria-label="Follow @patrickelectric on GitHub">Follow @patrickelectric</a>
                              <ul class="author__urls social-icons">

                                  <li itemprop="homeLocation" itemscope="" itemtype="http://schema.org/Place">
                                    <svg class="svg-inline--fa fa-map-marker-alt fa-w-12 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="map-marker-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" data-fa-i2svg=""><path fill="currentColor" d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z"></path></svg><!-- <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> --> <span itemprop="name">Brazil</span>
                                  </li>
                                  <li>
                                    <a href="mailto:patrickjp@kde.org">
                                      <meta itemprop="email" content="patrickjp@kde.org">
                                      <svg class="svg-inline--fa fa-envelope-square fa-w-14 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="envelope-square" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"></path></svg><!-- <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> --> Email
                                    </a>
                                  </li>
                                  <li>
                                    <a href="https://github.com/patrickelectric" itemprop="sameAs">
                                      <svg class="svg-inline--fa fa-github fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-fw fa-github" aria-hidden="true"></i> --> GitHub
                                    </a>
                                  </li>
                                    <li>
                                      <a href="https://www.youtube.com/user/electric7777777" itemprop="sameAs">
                                        <svg class="svg-inline--fa fa-youtube fa-w-18 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg><!-- <i class="fab fa-fw fa-youtube" aria-hidden="true"></i> --> YouTube
                                      </a>
                                    </li>
                              </ul>
                            </div>
                            
                        
                    </div>

                    <ul class="sidebar-nav">
                        
                        
                        
                    </ul>
                </div>
            </div>
        

        <div class="content container">
            
<div class="post">
  <h1 class="post-title">QT3D, Lines and AtCore</h1>
  <span class="post-date">2017-07-02</span>
  <h3 class="post-tags">[
  
  <a href="/tags/AtCore">AtCore</a>
  
  <a href="/tags/Atelier">Atelier</a>
  
  <a href="/tags/KDE">KDE</a>
  
  <a href="/tags/QT3D">QT3D</a>
  
  ]</h3>
  <p>After some time working with Qt3D, now Atelier project is one step closer to have a 3D viewer from the GCode and a realtime draw of printer work.</p>
<span id="continue-reading"></span>
<p><img src="/assets/QT3DLines/atcore.gif" alt="3D draw with lines" /></p>
<p>To know how Qt3D works, you can take a look in this <a href="https://doc.qt.io/qt-5/qt3d-overview.html">overview</a>. Where, working with 3D lines was a bit problematic, but I hope to help someone with this job.</p>
<h1 id="rendering">Rendering</h1>
<p>To render, we need our mesh and the material. This simple cube have something more than 1300 lines, and if you are thinking about it, you can can handle big models like this <a href="https://www.thingiverse.com/thing:51415">Dragon Head</a> with around 706000 lines in 60fps.</p>
<p><img src="/assets/QT3DLines/dragon.png" alt="dragon" /></p>
<h3 id="mesh">Mesh</h3>
<p>It's done with a C++ code, where a 4D vector is used to perform the buffer population, the 4D is because a 3D printer have 4 dimensions in a actuation space, (X, Y, Z and E) where E is the extruder that move the filament to perform the extrusion.</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">LineMeshGeometry::LineMeshGeometry</span><span style="color:#c0c5ce;">(QList&lt;QVector4D&gt; </span><span style="color:#bf616a;">vertices</span><span style="color:#c0c5ce;">, Qt3DCore::QNode *</span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">) :
    </span><span style="color:#8fa1b3;">Qt3DRender::QGeometry</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">)
    , </span><span style="color:#bf616a;">_positionAttribute</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">new </span><span style="color:#bf616a;">Qt3DRender::QAttribute</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">))
    , </span><span style="color:#bf616a;">_vertexBuffer</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">new </span><span style="color:#bf616a;">Qt3DRender::QBuffer</span><span style="color:#c0c5ce;">(Qt3DRender::QBuffer::VertexBuffer, </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">))
{
    QByteArray vertexBufferData;
    vertexBufferData.</span><span style="color:#bf616a;">resize</span><span style="color:#c0c5ce;">(vertices.</span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">() * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">* sizeof(</span><span style="color:#b48ead;">float</span><span style="color:#c0c5ce;">));
    </span><span style="color:#b48ead;">float </span><span style="color:#c0c5ce;">*rawVertexArray = reinterpret_cast&lt;</span><span style="color:#b48ead;">float </span><span style="color:#c0c5ce;">*&gt;(vertexBufferData.</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">());
    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> idx = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const auto </span><span style="color:#c0c5ce;">&amp;v : vertices) {
        rawVertexArray[idx++] = v.</span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">();
        rawVertexArray[idx++] = v.</span><span style="color:#bf616a;">y</span><span style="color:#c0c5ce;">();
        rawVertexArray[idx++] = v.</span><span style="color:#bf616a;">z</span><span style="color:#c0c5ce;">();
        _vertices.</span><span style="color:#bf616a;">append</span><span style="color:#c0c5ce;">(v.</span><span style="color:#bf616a;">toVector3D</span><span style="color:#c0c5ce;">());
    }

    _vertexBuffer-&gt;</span><span style="color:#bf616a;">setData</span><span style="color:#c0c5ce;">(vertexBufferData);

    _positionAttribute-&gt;</span><span style="color:#bf616a;">setAttributeType</span><span style="color:#c0c5ce;">(Qt3DRender::QAttribute::VertexAttribute);
    _positionAttribute-&gt;</span><span style="color:#bf616a;">setBuffer</span><span style="color:#c0c5ce;">(_vertexBuffer);
    _positionAttribute-&gt;</span><span style="color:#bf616a;">setDataType</span><span style="color:#c0c5ce;">(Qt3DRender::QAttribute::Float);
    _positionAttribute-&gt;</span><span style="color:#bf616a;">setDataSize</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">);
    _positionAttribute-&gt;</span><span style="color:#bf616a;">setName</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">Qt3DRender::QAttribute::defaultPositionAttributeName</span><span style="color:#c0c5ce;">());

    </span><span style="color:#bf616a;">addAttribute</span><span style="color:#c0c5ce;">(_positionAttribute);
}

</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">LineMeshGeometry::vertexCount</span><span style="color:#c0c5ce;">()
{
    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> _vertices.</span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">();
}
</span></pre>
<p>With this done, it's possible to easy populate it with a simple class.</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">LineMesh::LineMesh</span><span style="color:#c0c5ce;">(Qt3DCore::QNode *</span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">) :
    </span><span style="color:#8fa1b3;">Qt3DRender::QGeometryRenderer</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">)
    , </span><span style="color:#bf616a;">_lineMeshGeo</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">nullptr</span><span style="color:#c0c5ce;">)
{
    </span><span style="color:#bf616a;">setInstanceCount</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
    </span><span style="color:#bf616a;">setIndexOffset</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
    </span><span style="color:#bf616a;">setFirstInstance</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
    </span><span style="color:#65737e;">// This will allow the line visualization
    </span><span style="color:#bf616a;">setPrimitiveType</span><span style="color:#c0c5ce;">(Qt3DRender::QGeometryRenderer::LineStrip);

    </span><span style="color:#65737e;">// This will be visualized in qml
    </span><span style="color:#bf616a;">qRegisterMetaType</span><span style="color:#c0c5ce;">&lt;QList&lt;QVector4D&gt; &gt;(&quot;</span><span style="color:#a3be8c;">QList&lt;QVector4D&gt;</span><span style="color:#c0c5ce;">&quot;);
    </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> gcode = </span><span style="color:#b48ead;">new </span><span style="color:#bf616a;">GcodeTo3D</span><span style="color:#c0c5ce;">();
    </span><span style="color:#bf616a;">connect</span><span style="color:#c0c5ce;">(gcode, &amp;GcodeTo3D::posFinished, </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">, &amp;LineMesh::posUpdate);
}

</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">LineMesh::posUpdate</span><span style="color:#c0c5ce;">(QList&lt;QVector4D&gt; </span><span style="color:#bf616a;">pos</span><span style="color:#c0c5ce;">)
{
    _vertices = pos;
    _lineMeshGeo = </span><span style="color:#b48ead;">new </span><span style="color:#bf616a;">LineMeshGeometry</span><span style="color:#c0c5ce;">(_vertices, </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">);
    </span><span style="color:#bf616a;">setVertexCount</span><span style="color:#c0c5ce;">(_lineMeshGeo-&gt;</span><span style="color:#bf616a;">vertexCount</span><span style="color:#c0c5ce;">());
    </span><span style="color:#bf616a;">setGeometry</span><span style="color:#c0c5ce;">(_lineMeshGeo);
    emit </span><span style="color:#bf616a;">finished</span><span style="color:#c0c5ce;">();
}
</span></pre><h3 id="material-and-entity">Material and Entity</h3>
<p>The material used in the first GIF was <a href="https://doc.qt.io/qt-5/qml-qt3d-extras-phongmaterial.html">PhongMaterial</a>, this is simple done with:</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PhongMaterial {
  id: lineMaterial
  ambient: &quot;darkGreen&quot;
}
</span></pre>
<p>And in the end, the creation of an Entity.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">LineMesh {
  id: lineMesh
  enabled: true
}
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">Entity {
  id: lineEntity
  components: [ lineMesh, lineMaterial ]
}
</span></pre>
<p>In the next week we plan to finish our simple 3D viwer and add it in AtCore test GUI.\
For more info about <a href="https://github.com/kde/atcore">AtCore and Atelier click here !</a></p>
<p><img src="/assets/QT3DLines/cube2.png" alt="Cube 2" /></p>

</div>

        </div>

    </body>

</html>
