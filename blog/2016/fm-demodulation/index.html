<!DOCTYPE html>
<html lang="en">
    <head>
      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
      <link rel="manifest" href="/site.webmanifest">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

      <title>Patrick José Pereira</title>

      <!-- CSS -->
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;print.css" media="print">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;poole.css">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;patrickelectric.work&#x2F;hyde.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

      

      
      
    </head>

    <body class=" ">
        
            <div class="sidebar">
                <div class="container sidebar-sticky">
                    <div class="sidebar-about">
                        
                          <a href="https:&#x2F;&#x2F;patrickelectric.work"><h2>HOME</h2></a>
                            <div class="avatar"> <img src="https://avatars3.githubusercontent.com/patrickelectric" alt="Patrick José Pereira" itemprop="image"> </div>
                            <h6>Patrick José Pereira</h6>
                            
                            <p class="lead">I am an Electronics Engineer that works with robotic systems, OSS and OSH.</p>
                            <div class="author__urls-wrapper">
                              <!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>
                              <!-- Place this tag where you want the button to render. -->
<!-- Place this tag where you want the button to render. -->
<a class="github-button" href="https://github.com/patrickelectric" data-show-count="true" aria-label="Follow @patrickelectric on GitHub">Follow @patrickelectric</a>
                              <ul class="author__urls social-icons">

                                  <li itemprop="homeLocation" itemscope="" itemtype="http://schema.org/Place">
                                    <svg class="svg-inline--fa fa-map-marker-alt fa-w-12 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="map-marker-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" data-fa-i2svg=""><path fill="currentColor" d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z"></path></svg><!-- <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> --> <span itemprop="name">Brazil</span>
                                  </li>
                                  <li>
                                    <a href="mailto:patrickjp@kde.org">
                                      <meta itemprop="email" content="patrickjp@kde.org">
                                      <svg class="svg-inline--fa fa-envelope-square fa-w-14 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="envelope-square" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM178.117 262.104C87.429 196.287 88.353 196.121 64 177.167V152c0-13.255 10.745-24 24-24h272c13.255 0 24 10.745 24 24v25.167c-24.371 18.969-23.434 19.124-114.117 84.938-10.5 7.655-31.392 26.12-45.883 25.894-14.503.218-35.367-18.227-45.883-25.895zM384 217.775V360c0 13.255-10.745 24-24 24H88c-13.255 0-24-10.745-24-24V217.775c13.958 10.794 33.329 25.236 95.303 70.214 14.162 10.341 37.975 32.145 64.694 32.01 26.887.134 51.037-22.041 64.72-32.025 61.958-44.965 81.325-59.406 95.283-70.199z"></path></svg><!-- <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> --> Email
                                    </a>
                                  </li>
                                  <li>
                                    <a href="https://github.com/patrickelectric" itemprop="sameAs">
                                      <svg class="svg-inline--fa fa-github fa-w-16 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-fw fa-github" aria-hidden="true"></i> --> GitHub
                                    </a>
                                  </li>
                                    <li>
                                      <a href="https://www.youtube.com/user/electric7777777" itemprop="sameAs">
                                        <svg class="svg-inline--fa fa-youtube fa-w-18 fa-fw" aria-hidden="true" data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg><!-- <i class="fab fa-fw fa-youtube" aria-hidden="true"></i> --> YouTube
                                      </a>
                                    </li>
                              </ul>
                            </div>
                            
                        
                    </div>

                    <ul class="sidebar-nav">
                        
                        
                        
                    </ul>
                </div>
            </div>
        

        <div class="content container">
            
<div class="post">
  <h1 class="post-title">FM with IQ Demodulation</h1>
  <span class="post-date">2016-12-10</span>
  <h3 class="post-tags">[
  
  <a href="/tags/Radio">Radio</a>
  
  <a href="/tags/FM">FM</a>
  
  <a href="/tags/Math">Math</a>
  
  <a href="/tags/Demodulation">Demodulation</a>
  
  ]</h3>
  <p>After some time reading about hacking RF signals:</p>
<span id="continue-reading"></span><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<ul>
<li><a href="http://www.asciimation.co.nz/bb/2014/03/19/using-rtl-sdr-to-automatically-receive-weather-satellite-images">Using RTL-SDR to automatically receive weather satellite
images. </a></li>
<li><a href="https://hackaday.com/2015/09/20/reverse-engineering-traffic-lights-with-software-defined-radio/">Reverse engineering traffic lights with software defined radio.</a></li>
<li><a href="https://hackaday.com/2015/08/22/spectrum-painting-on-2-4-ghz/">Spectrum painting on 2.4 GHz.</a></li>
<li><a href="http://www.rtl-sdr.com/adsb-aircraft-radar-with-rtl-sdr/">RTL-SDR Tutorial: Cheap ADS-B aircraft radar</a></li>
</ul>
<p>I bought a RTL2832U receiver, that can operate on a range of 70-1700 Mhz.</p>
<p><img src="/assets/fm_demodulation/rtl-1024x576.jpg" alt="RTL" /></p>
<p><a href="http://pt.aliexpress.com/item/USB2-0-Digital-DVB-T-SDR-DAB-FM-HDTV-TV-Tuner-Receiver-Stick-HE-RTL2832U-R820T/32357851768.html">Aliexpress link.</a></p>
<h1 id="libraries-and-programs">Libraries and Programs</h1>
<p>After some time (6 months, hell yeah Brazil...) to receive the package, I begun to install all the programs and libraries to use the RTL.</p>
<pre style="background-color:#2b303b;">
$ sudo apt-get install gnuradio rtl-sdr gqrx-sdr
</pre>
<ul>
<li>
<p>gnuradio : GNU Radio is a free software development toolkit that provides signal processing blocks to implement software-defined radios and signal processing systems. It
can be used with external RF hardware to create software-defined radios, or without hardware in a simulation-like environment. It is widely used in hobbyist, academic, and
commercial environments to support both wireless communications research and real-world radio systems. (ty wikipedia).</p>
<p><img src="/assets/fm_demodulation/gnuradio-1024x576.png" alt="gnuradio interface. (like simulink but isn't java)" /></p>
</li>
<li>
<p>rtl-sdr have:</p>
</li>
</ul>
<p>`</p>
<pre style="background-color:#2b303b;">
 * rtl_adsb: a simple ADS-B decoder for RTL2832 based DVB-T receivers
 * rtl_eeprom: an EEPROM programming tool for RTL2832 based DVB-T receivers
 * rtl_fm: a narrow band FM demodulator for RTL2832 based DVB-T receivers
 * rtl_sdr: an I/Q recorder for RTL2832 based DVB-T receivers
 * rtl_tcp: an I/Q spectrum server for RTL2832 based DVB-T receivers
 * rtl_test: a benchmark tool for RTL2832 based DVB-T receivers
</pre>
<p>`</p>
<ul>
<li>gqrx-sdr is a RF receive interface that have a displays FFT plot and spectrum waterfall very helpful to detect signals,  the software includes AM, SSB, FM-N, FM-W (mono
and stereo) demodulators and Special FM mode for NOAA APT.</li>
</ul>
<p><img src="/assets/fm_demodulation/gqrx-1024x576.png" alt="gqrx interface." /></p>
<p>After installed all the software and plugging the receiver on the computer, we can see that have a Realtek chip with the lsusb feedback.</p>
<pre style="background-color:#2b303b;">
Bus 001 Device 004: ID 0bda:2838 Realtek Semiconductor Corp. RTL2838 DVB-T
</pre>
<p>Ok, now with everything done,  we can capture some data ! We can use the rtl-sdr toolkit.</p>
<pre class="wiki">rtl_sdr capture.bin -s 1.8e6 -f 100.9e6</pre>
<p>The capture.bin is the file that will have the IQ data, 1.8 MHz is the sample frequency and the frequency that we will look for is 100.9MHz (Rádio Atlântida), the radio
station.</p>
<p>Warning !! 1.8e6 samples for second, so take 3~10 seconds because the fast growing of the file.</p>
<h1 id="to-demodulate-we-need-do-understand-the-modulation">To demodulate we need do understand the modulation.</h1>
<p>The FM is a method to modulate a message $m(t)$ with the change of the carrier <span class="MathJax_Preview">![cos(2\pi f_c t)]</span> <script type="math/tex">cos(2\pi f_c
t)</script> phase's <span
class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_56bc496f2eefa3002ee6d223c29c9fde.gif?w=474" alt="\phi(t)" /></span><script
type="math/tex">\phi(t)</script>. <a href="https://en.wikipedia.org/wiki/Frequency_modulation">Wikipedia is your friend.</a></p>
<p>The phase have a relationship with the message, that is <span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_6b83d3eb197efdbec2148d2f5cc7f357.gif?w=474" alt="\phi(t) = 2\pi K_f \int^t_0 m(u)du" /></span><script type="math/tex">\phi(t) = 2\pi K_f
\int^t_0 m(u)du</script>. So the simple FM modulator will look like:</p>
<p><img src="/assets/fm_demodulation/fm_modulator-1024x434.png" alt="FM modulator" /></p>
<p>The <span class="MathJax_Preview"><img src="http://i1.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_4f37783823fc5bcb18cec232f7563904.gif?w=474" alt="s(t)" /></span><script
type="math/tex">s(t)</script> data will be transmitted after the modulation.</p>
<h1 id="demodulate-fm-iq-decomposition">Demodulate FM, IQ Decomposition.</h1>
<p>The RTL driver give to us the result of the QAM demodulator.</p>
<p><img src="/assets/fm_demodulation/qam_demodulator-1024x411.png" alt="QAM Demodulator" /> Where:</p>
<p><span class="MathJax_Preview"><img src="http://i2.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_16356e909e03cbcbc0836ab3fd11eab1.gif?w=474" alt="s(t) = Acos(2\pi f_ct+\phi(t))" /></span><script type="math/tex">s(t) = Acos(2\pi
f_ct+\phi(t))</script>
<span
class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_3118bc215041d051756f88e2d18bf8ef.gif?w=474" alt="cos(a+b)=cos(a)cos(b)-sin(a)*sin(b)" /></span><script
type="math/tex">cos(a+b)=cos(a)cos(b)-sin(a)*sin(b)</script>
<span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_58416d3915c13b55a2d0210753885309.gif?w=474" alt="s(t) = Acos(\phi(t))cos(2\pi f_ct) - Asin(\phi(t))sin(2\pi f_ct)" /></span><script type="math/tex">s(t) =
Acos(\phi(t))cos(2\pi f_ct) - Asin(\phi(t))sin(2\pi f_ct)</script>
<span class="MathJax_Preview"><img src="http://i2.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_d276b83fa58624d9e680cbebf1d1b3c6.gif?w=474" alt="s_I(t) = Acos(\phi(t))" /></span><script type="math/tex">s_I(t) =
Acos(\phi(t))</script>
<span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_7343408eb92dc0de86d8772fe6d67d52.gif?w=474" alt="s_Q(t) = Asin(\phi(t))" /></span><script type="math/tex">s_Q(t) =
Asin(\phi(t))</script>
<span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_db677c59f7c0d6b4974c961e1e755a81.gif?w=474" alt="\phi(t) = \sphericalangle (s_I(t)+js_Q(y))" /></span><script type="math/tex">\phi(t) =
\sphericalangle (s_I(t)+js_Q(y))</script></p>
<p>You can read more about IQ data <span class="MathJax_Preview"><img src="http://i1.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_611c418992f5abe9f86e14debafd41b7.gif?w=474" alt="s_I(t) s_Q(t)" /></span><script type="math/tex">s_I(t)
s_Q(t)</script> <a href="http://www.ni.com/tutorial/4805/en/">here</a>.</p>
<p>Now we know how to demodulate the FM, with the equations above, the result is:
<span class="MathJax_Preview"><img src="http://i2.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_9747dccd22de368a2debc5ee4c346120.gif?w=474" alt="m(t) = \frac{1}{(2\pi K_f)} \frac{d}{dt}(\sphericalangle (s_I(t)+js_Q(y))" /></span><script type="math/tex">m(t) =
\frac{1}{(2\pi K_f)} \frac{d}{dt}(\sphericalangle (s_I(t)+js_Q(y))</script></p>
<h1 id="some-code">Some code.</h1>
<p>Now, with the knowledge of how the FM modulation and demodulation work, we can write a octave code that can show to us how the theory work in the real world.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">%read file and convert data
</span><span style="color:#c0c5ce;">fid = </span><span style="color:#b48ead;">fopen</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">./capture2.bin</span><span style="color:#c0c5ce;">&#39;,&#39;</span><span style="color:#a3be8c;">rb</span><span style="color:#c0c5ce;">&#39;);
y = </span><span style="color:#b48ead;">fread</span><span style="color:#c0c5ce;">(fid,&#39;</span><span style="color:#a3be8c;">uint8=&amp;amp;amp;amp;amp;amp;amp;gt;double</span><span style="color:#c0c5ce;">&#39;);
y = y-</span><span style="color:#d08770;">127</span><span style="color:#c0c5ce;">;
</span><span style="color:#65737e;">% transform IQ data to an imaginary number
</span><span style="color:#c0c5ce;">yi = y(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:end)+</span><span style="color:#d08770;">i</span><span style="color:#c0c5ce;">*y(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:end);

</span><span style="color:#65737e;">% the radio frequency and the sample frequency
</span><span style="color:#c0c5ce;">freq = </span><span style="color:#d08770;">100.9e6</span><span style="color:#c0c5ce;">;
fs = </span><span style="color:#d08770;">1.8e6</span><span style="color:#c0c5ce;">;

</span><span style="color:#65737e;">% some math
</span><span style="color:#c0c5ce;">yang = </span><span style="color:#b48ead;">angle</span><span style="color:#c0c5ce;">(yi);     </span><span style="color:#65737e;">% take the angle -pi to pi
</span><span style="color:#c0c5ce;">yrap = </span><span style="color:#b48ead;">unwrap</span><span style="color:#c0c5ce;">(yang);  </span><span style="color:#65737e;">% make the correction to continue the angle after pi and -pi
</span><span style="color:#c0c5ce;">tdev = </span><span style="color:#b48ead;">diff</span><span style="color:#c0c5ce;">(yrap);    </span><span style="color:#65737e;">% the derivative of theta
</span><span style="color:#b48ead;">sound</span><span style="color:#c0c5ce;">(tdev,fs)        </span><span style="color:#65737e;">% give us some music
</span></pre>
<p>You can download the capture.bin that I have used and the .m code to octave (open source rules) here:
<a href="/assets/fm_demodulation/fm_demodulator_mono.zip">fm_demodulator_mono</a>.</p>
<p><audio class="wp-audio-shortcode" id="audio-120-1" preload="none" style="width: 100%;" controls="controls"><source type="audio/wav"
src="/assets/fm_demodulation/mono_fm.wav?_=1"><a href="/assets/fm_demodulation/mono_fm.wav">/assets/fm_demodulation/mono_fm.wav</a></audio></p>
<h1 id="stereo-demodulation">Stereo demodulation.</h1>
<p>Ok, we have done the simpliest demodulation possible, without filters and a lot of things, so now we will use more energy to obtain a <del>very good </del> <del>good</del>
cool sound.</p>
<h5 id="the-fm-spectrum">The FM spectrum</h5>
<p>The FM spectrum have more things that I thought.</p>
<ol>
<li>30~15kHz L+R (mono), that we have already demodulated.</li>
<li>19kHz, the omnipotent carrier.</li>
<li>23~53kHz, a kind of dsb-sc (double side band suppressed-carrier) with L-R.</li>
<li>55.35~58.65kHz, the RBDS (<del>Rebeldes</del> Radio Data system),  a kind of digital data system.</li>
<li>58.65~76.65kHz, FTF first <a href="https://en.wikipedia.org/wiki/DirectBand">read this</a>, now ask yourself wth Microsoft is here ??</li>
<li>92+<span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_8ed7235e4e012bce81ca345a6a3ea653.gif?w=474" alt="\Delta f_{as}" /></span><script type="math/tex">\Delta
f_{as}</script>, <a href="https://en.wikipedia.org/wiki/Subcarrier">IDKWII</a>.</li>
</ol>
<p><img src="/assets/fm_demodulation/FM-band.png" alt="tys wikipedia" /></p>
<figcaption class="wp-caption-text">tys wikipedia</figcaption>
<h6 id="what-is-important">What is important ?</h6>
<p>The FM modulation appears to be something like this:</p>
<p><a href="/assets/fm_demodulation/modulador_FM_tudo1.png"><img src="/assets/fm_demodulation/modulador_FM_tudo1.png?resize=474%2C199" alt="" /></a></p>
<p>Mathematically:</p>
<p><span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_6c836c3ce0a026c8f7af559b3307bd25.gif?w=474" alt="s(t) = cos(2\pi f_c+\phi(t))" /></span><script type="math/tex">s(t) = cos(2\pi
f_c+\phi(t))</script>
Where <span class="MathJax_Preview"><img src="http://i2.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_4809f8f5cd44e1b8d6ad5ea6ae932e07.gif?w=474" alt="\phi(t) = 2 \pi K_f\int[m_R(t)+m_L(t)+ (m_R(t)-m_L(t))cos(4\pi f_c t)+RBDS(t)cos(6\pi f_c t)]" /></span><script type="math/tex">\phi(t) = 2 \pi
K_f\int[m_R(t)+m_L(t)+ (m_R(t)-m_L(t))cos(4\pi f_c t)+RBDS(t)cos(6\pi f_c t)]</script>.</p>
<p>Yeah, this is a kind of crazy. The IQ data give to us the imaginary part that compose the <span
class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_56bc496f2eefa3002ee6d223c29c9fde.gif?w=474" alt="\phi(t)" /></span><script
type="math/tex">\phi(t)</script>, theoretically making the FFT of <span
class="MathJax_Preview"><img src="http://i2.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_b7893f79356a6305f50f23d9aa9194bb.gif?w=474" alt="\frac{d}{dt}\phi(t)" /></span><script
type="math/tex">\frac{d}{dt}\phi(t)</script> we can see something like the FM spectrum image.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">% fft
 </span><span style="color:#c0c5ce;">tdfft = </span><span style="color:#b48ead;">fft</span><span style="color:#c0c5ce;">(tdev);
 P2=</span><span style="color:#b48ead;">abs</span><span style="color:#c0c5ce;">(tdfft/ysize);
 P1=P2(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:ysize/</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
 P1(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:end-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*P1(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:end-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
 f=fs*(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">:(ysize/</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">))/ysize;
 </span><span style="color:#65737e;">% plot the fft until 59kHz
 </span><span style="color:#c0c5ce;">freqe=</span><span style="color:#b48ead;">round</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">59e3</span><span style="color:#c0c5ce;">*</span><span style="color:#b48ead;">size</span><span style="color:#c0c5ce;">(f)/fs);
 freqe=freqe(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);
 </span><span style="color:#96b5b4;">plot</span><span style="color:#c0c5ce;">(f(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:freqe),(P1(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:freqe)))
 </span><span style="color:#96b5b4;">grid </span><span style="color:#d08770;">on
 </span><span style="color:#96b5b4;">xlabel </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">freq Hz</span><span style="color:#c0c5ce;">&#39;,</span><span style="color:#96b5b4;">ylabel </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">dB</span><span style="color:#c0c5ce;">&#39;
 </span><span style="color:#96b5b4;">hold </span><span style="color:#d08770;">on
 </span><span style="color:#96b5b4;">axis</span><span style="color:#c0c5ce;">([</span><span style="color:#d08770;">30 59e3 0 0.02</span><span style="color:#c0c5ce;">])

 Gab1 = [</span><span style="color:#d08770;">30 0</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">30 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">15e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">15e3 0</span><span style="color:#c0c5ce;">]; </span><span style="color:#65737e;">% R+L
 </span><span style="color:#96b5b4;">plot</span><span style="color:#c0c5ce;">(Gab1(:,</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),Gab1(:,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">),&#39;</span><span style="color:#a3be8c;">g</span><span style="color:#c0c5ce;">&#39;);

 Gab1 = [</span><span style="color:#d08770;">18.5e3 0</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">18.5e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">19.5e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">19.5e3 0</span><span style="color:#c0c5ce;">]; </span><span style="color:#65737e;">% carrier
 </span><span style="color:#96b5b4;">plot</span><span style="color:#c0c5ce;">(Gab1(:,</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),Gab1(:,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">),&#39;</span><span style="color:#a3be8c;">b</span><span style="color:#c0c5ce;">&#39;);

 Gab1 = [</span><span style="color:#d08770;">23e3 0</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">23e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">53e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">53e3 0</span><span style="color:#c0c5ce;">]; </span><span style="color:#65737e;">% R-L
 </span><span style="color:#96b5b4;">plot</span><span style="color:#c0c5ce;">(Gab1(:,</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),Gab1(:,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">),&#39;</span><span style="color:#a3be8c;">r</span><span style="color:#c0c5ce;">&#39;);

 Gab1 = [</span><span style="color:#d08770;">55.35e3 0</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">55.35e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">58.65e3 0.02</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">58.65e3 0</span><span style="color:#c0c5ce;">]; </span><span style="color:#65737e;">% RBDS
 </span><span style="color:#96b5b4;">plot</span><span style="color:#c0c5ce;">(Gab1(:,</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),Gab1(:,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">),&#39;</span><span style="color:#a3be8c;">c</span><span style="color:#c0c5ce;">&#39;);
</span></pre>
<p>And the result:</p>
<p><img src="/assets/fm_demodulation/spectrum_FM.png" alt="fm_demo" /></p>
<p>All good, all good sir !</p>
<h5 id="the-carrier-and-his-friends">The carrier and his friends.</h5>
<p>Like said before, we have the IQ data that can give to us the <span
class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_56bc496f2eefa3002ee6d223c29c9fde.gif?w=474" alt="\phi(t)" /></span><script
type="math/tex">\phi(t)</script> and with a derivative we can have <span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_9dbb40352d1c6dc23d22845e9dc63490.gif?w=474" alt="m_R(t)+m_L(t)+ (m_R(t)-m_L(t))cos(4\pi f_c t)+RBDS(t)cos(6\pi f_c t)" /></span><script type="math/tex">m_R(t)+m_L(t)+
(m_R(t)-m_L(t))cos(4\pi f_c t)+RBDS(t)cos(6\pi f_c t)</script>. Applying a low-pass filter on the L+R, a band-pass filter on the carrier, L-R and RBDS we can have a clear
signal of each data.</p>
<p>With the frequencies specifications, the filter was done:</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">%R+L
</span><span style="color:#c0c5ce;">[b,a] = </span><span style="color:#96b5b4;">butter</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">16e3</span><span style="color:#c0c5ce;">/fs,&#39;</span><span style="color:#a3be8c;">low</span><span style="color:#c0c5ce;">&#39;);
R_p_L = </span><span style="color:#b48ead;">filter</span><span style="color:#c0c5ce;">(b,a,tdev);
hhhh=R_p_L;
plote

</span><span style="color:#65737e;">%carrier
</span><span style="color:#c0c5ce;">[b,a] = </span><span style="color:#96b5b4;">butter</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">,[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">18.5e3</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">19.5e3</span><span style="color:#c0c5ce;">]/fs,&#39;</span><span style="color:#a3be8c;">bandpass</span><span style="color:#c0c5ce;">&#39;);
carrier = </span><span style="color:#b48ead;">filter</span><span style="color:#c0c5ce;">(b,a,tdev);
hhhh=carrier;
plote

</span><span style="color:#65737e;">% R-L
</span><span style="color:#c0c5ce;">[b,a] = </span><span style="color:#96b5b4;">butter</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">,[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">23e3</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">53e3</span><span style="color:#c0c5ce;">]/fs,&#39;</span><span style="color:#a3be8c;">bandpass</span><span style="color:#c0c5ce;">&#39;);
R_l_L = </span><span style="color:#b48ead;">filter</span><span style="color:#c0c5ce;">(b,a,tdev);
hhhh=R_l_L;
plote

</span><span style="color:#65737e;">%RBDS
</span><span style="color:#c0c5ce;">[b,a] = </span><span style="color:#96b5b4;">butter</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">,[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">55.35e3</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">58.65e3</span><span style="color:#c0c5ce;">]/fs,&#39;</span><span style="color:#a3be8c;">bandpass</span><span style="color:#c0c5ce;">&#39;);
rbds = </span><span style="color:#b48ead;">filter</span><span style="color:#c0c5ce;">(b,a,tdev);
hhhh=rbds;
plote
</span></pre>
<p>The 'plote' code plot the fft of the signal.</p>
<p><span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_26fa20951173011eb56e82a0520beefd.gif?w=474" alt="m_R(t)+m_L(t)" /></span><script type="math/tex">m_R(t)+m_L(t)</script></p>
<p><a href="/assets/fm_demodulation/rpl.png"><img src="/assets/fm_demodulation/rpl.png?resize=474%2C356" alt="rpl" /></a></p>
<p><span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_fbe7de253c63357b060a5ba2c244065d.gif?w=474" alt="cos(2\pi f_c t)" /></span><script type="math/tex">cos(2\pi f_c t)</script></p>
<p><a href="/assets/fm_demodulation/carrier.png"><img src="/assets/fm_demodulation/carrier.png?resize=474%2C356" alt="carrier" /></a><span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_02ecbfc1758b061f8ba5a2532b1cf418.gif?w=474" alt="(m_R(t)-m_L(t))cos(4\pi f_c t)" /></span><script type="math/tex">(m_R(t)-m_L(t))cos(4\pi f_c t)</script></p>
<p><a href="/assets/fm_demodulation/rll.png"><img src="/assets/fm_demodulation/rll.png?resize=474%2C356" alt="rll" /></a></p>
<p><span class="MathJax_Preview"><img src="http://i0.wp.com/patrickjp.com/wp-content/plugins/latex/cache/tex_6147ad2cc82784588b521e1a4a7514e4.gif?w=474" alt="RBDS(t)cos(6\pi f_c t)" /></span><script type="math/tex">RBDS(t)cos(6\pi f_c t)</script></p>
<p><a href="/assets/fm_demodulation/rbds.png"><img src="/assets/fm_demodulation/rbds.png?resize=474%2C356" alt="rbds" /></a></p>
<p>To be continue..</p>

</div>

        </div>

    </body>

</html>
